


# Product Brief

Business objective
------------------

We believe that to support the fast-moving and creative spirit of the Kusama ecosystem, a protocol like Angular is a necessary primitive in order to allow other teams to build and experiment with further DeFi primitives that utilize leverage.


---

Why is this important right now?
--------------------------------

Complex applications and products are coming to Kusama

*   Sophisticated financial tools are readily available in centralized finance
*   Building blocks with the ability to leverage lending protocols to create these financial tools in DeFi are crucial for a broader adoption of DeFi.


What are we solving for?
------------------------

Angular - an isolated lending pair one-sided permissionless protocol, designed to isolate risk and set to open new opportunities for use cases such as:

*   Leverage on interest bearing assets
*   Lending protocol for leveraged trading, options, and derivatives
*   Generating yield from any asset


Design considerations
---------------------

_What the designer should keep in mind as they move forward with designs._


Analytics Considerations
------------------------

_Define which events need to be tracked._


Release plan
------------

_Outline what phases or milestones are associated with the release._




# Staking

You want to provide assets to be part of borrow amount from market. You stake amount and get fNFT for 3 month. 

You may split/sell fNFT. fNFT has lower price because of value locked, but you assume your earn more by having 

Borrow is used on market. 

# veAngular

As equivalent of staken amount in normalized (stable coing usually) asset you get amount of veANGL 
veANGL shared accross pools. 


# Chiesel model with an integration of Bribe

??



Does vault penalizes for fequent withdrawsl of Borrow assets?

Penalize withdarawal of assets. 

## TODO:

- read whitepaper and medium article
- outline how it works well with vault pallet
- outline how it works with staking-rewards pallet


# Flash loans

See @KaiserKarel doc on that.


# NFT as collateral

fNFT as collateral. how to determine price? worth return in case of immediate return with penalty? what is penalty?


- ? lender puts amount into `staking-reward`, amount is taken into lending pool,
- ? lender can sell non fungible position


# Persmissioless creation veANGL contolled

So when we create any pool, we need to take ED of veANGL.
veANGL obtained by locking into vault or reward-staking.
? veANGL price is one to one with normalized asset

# Iron bank functionality


# Cross chain

? is it guide on how to create foreign assets to be handled by XCMP/IBC/MOSAIC?

## Leverage as Service (generalized leverage protocol)

- No collateral
- Limited whitelisted protocols to be used


### Implementation

### Leverage pallet

Permissioned only

- ? voted by veANGL?
- second pallet for councel

#### Storage

- Credit Account

#### Extrinsics

- allows you to borrow with collateral equal to some smal amount to cover nearest dept 
- allows to send token to chaos, to pablo
- allows to do some calls on chaos and pablo
- actually this is impersonated proxy
- permissioned adding of protocols (initially encoding directly)
- ? to be truly composable, need XCMV
  
## Scenario

- Deposit 25 ETH
- Borrow 100 ETH on top (4x)
- Swap to 125 ETH to USDC
- Put USDC into Pablo or Chaos
- Shorted postion agains ETH 

 
Lending pool which allows users to obtain leverage to use with other protocols which have been whitelisted. Gearbox is the most prominent example, but there are others including Sentiment which offer a similar product [1] [2]. While there are various existing protocols offering leverage, especially in the DeFi derivatives space, this concept of generalized leverage, or leverage as a primitive, expands upon the use cases, strategies, and freedom with which margin can be utilized across DeFi. Using Angular Finance as the base layer, we are in a unique position to offer a robust entrant to this exciting new field, which will allow for both the creation of sophisticated strategies which we can offer, allows to maximize exposure to vaults and yield farms of choosing. T

Liquidity Providers deposit assets into a pool, from which users can borrow on margin and take the borrowed asset to protocols of their choice. These initially would include Pablo, CHAOS, and other defi protocols we launch on Picasso, but can be expanded to include others which are deemed suitable for such a service. Any assets purchased on margin must remain in the custody of the protocol until the loan has been repaid, at which point the user keeps the profit minus the accrued fees. 

# Liqudation with ML for better collaterizaion

https://docs.google.com/document/d/1oJSQozCljna1zStVU4N6YpX0RvN0jX1rwyC540fH9HM

? Real time adjustments of factor


## Concentrated Lending

See [Uniswap v3]

- ? do not return fee directly to vault, allow to decide later, so it does not changes utilization ratio. Can send to pallet-staking.
- ? liquidity provided for different Interest Rates

### Areas

- need order book
- need order book integrated with lending
- need lending configurable approciately (ticks if Interest rate)


# Options protocol

Buy rigth to borrow some amount for some amount collateral in future? Is OB needed?


# Hedge engine


# others

just briefly explain

https://docs.euler.finance/getting-started/white-paper




# Defer liquidity check at the end for more complex structuring

???

# Free flash loan

? what means free

# Risk-adjusted liability value with siloting ltv

# Twap oracle factored by weth - to increase cost of arb

? Should we add wETH to XCMP?

# Dutch auction against miners/front-running bots.

We have that and kind of call it from liqudations, where it else to be used?

# Discount booster for MM to avoid liquidation bot profit during the dutch auction.

Is it like prefered liquidatior account? We had that notion once. So it will be able to buy by the price which will be X blocks ahead ? 

# Sell your discount booster for additional yield - this is probably what is going to happen by MM

So it is like membership pallet where places are sold

Stability pool is their internal keeper bot liquidation.

Soft liquidation allows the liquidator to repay the margin call + additional safety factor.

# Insurance fund to avoid run-at-bank and bad debt.

TODO: recheck if that is compatible with vault


# Dynamic interest modeling but with an only internal feedback loop. [should be more dynamics with external yield potential as feedback loops and cross-pool/assets optimization internally.]

# Arb between per the second basis vs per block. - to check. [weakness]

# Transaction builder is cool like defihedge, to optimize gas-fee by sending structured orders.

can provide WASM JS sdk to build common transactions for common set operations, so JS people can build complex TX on their own. 

# Sub-account ok

# missing: optimal cross-pool deployment based on utilization and external yield potential on their dynamic rate modeling.  risk/tricky to have per sec vs per block especially on eth with 'low tps'  there is few improvement here and there who can make sense but not sure it will be enough for attracting tvl to be top1

#  delta-neutral liquidity 

https://twitter.com/guil_lambert/status/1481280620072472580?s=20&t=UNSvmv3QJbmhfp8bNg2nJQ

# Syntetic assets lending



https://hackmd.io/@353yQn6WTImF5o12LQXXfQ/H12oHnWAF


## References

[Whitepaper Uniswap v3](https://uniswap.org/whitepaper-v3.pdf)
[Finematics Uniswap v3](https://www.youtube.com/watch?v=Ehm-OYBmlPM)
[Sentiment](https://medium.com/@sentimentxyz/sentiment-intro-79edf616e7c2)
[Sentiment Twitter](https://twitter.com/sentimentxyz?s=21it)
[Gearbox Creditaccounts Whitepaper](https://static.gearbox.fi/docs/Gearbox.pdf)
[zklend](https://medium.com/zklend/introducing-zklend-coming-out-of-stealth-mode-92090d3ce1db)



# References

## Summary

https://tatum.delphidigital.io/wp-json/delphi_api/v1/reports/breaking-down-the-design-space-of-money-market-liquidations/download?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwczpcL1wvdGF0dW0uZGVscGhpZGlnaXRhbC5pbyIsImlhdCI6MTY0OTkzMjI5MSwibmJmIjoxNjQ5OTMyMjkxLCJleHAiOjE2NTA1MzcwOTEsImRhdGEiOnsidXNlciI6eyJpZCI6IjQ4NDMifX19.kWZbf5QvWDzVgQw2bju752jv36bmd_GPkFFV_rkkcVE

### Gearbox


[Gearbox Protocol](https://consensys.net/blog/cryptoeconomic-research/gearbox-protocol-a-composable-leverage-protocol-in-defi/)

[Gearbox overview](https://medium.com/gearbox-protocol/leverage-2-0-credit-account-as-a-defi-primitive-8be6ea86e883) Credit Accounts for Leverage in Permissioned Protocols 

### Wrap v2 (Blacksmith)

[https://www.warp.finance/](https://www.warp.finance/) | Angular is modelled after that

### Yearn

[https://yearn.finance/#/home](https://yearn.finance/#/home) -Is Full cycle Farming      

### Makerdao

[https://makerdao.com/en/](https://makerdao.com/en/)Collaterized Multi assets pools with minted Stability fees in DAI tokens

### Moonwell

https://docs.moonwell.fi/moonwell-finance/overview/what-is-moonwell 


### Genshiro

https://genshiro.equilibrium.io/docs/genshiro-whitepaper.pdf - uses stats on accounts to calculate per account collateral and manage intererest per account using offchain bots


### Astaria

https://hackmd.io/@353yQn6WTImF5o12LQXXfQ/H12oHnWAF#Astaria  - solves isolated pairs liqudity problem by making syntetic assets

[COM-LendingFeatures-030122-1046.pdf](references/COM-LendingFeatures-030122-1046.pdf)


### Silo

Bridge assest used to produce concenrated liquidituy with common pool asset which is auction-bid mechanism stablecoin.

Bridged Lending Pair.

#### Reward for borrow

When user borrows, he gets $SILO token.
He can lock $SILO token and get reduced borrow rate.

? can he used fNFT with locked SILO for voting?
? does he needs amount of SILO to repay borrow?

https://medium.com/silo-protocol/proposal-silo-stablecoin-db5f6d8e2de9  - auction-bid mechanism

https://twitter.com/SiloFinance/status/1513973916250914816


https://twitter.com/kamikaz_ETH/status/1513139548683128835


https://twitter.com/tbr90/status/1513904811263119361

https://twitter.com/omaronchain/status/1514721348362379264

https://resources.silo.finance/welcome-to-silo/why-secure-money-markets

https://resources.silo.finance/

### Eurler

https://twitter.com/macromate8/status/1508810487068348424 

https://messari.io/article/euler-finance

# Bastion

https://twitter.com/BastionProtocol/status/1514787969147695110


# Solend

Isolated market pairs. Likely imitate pools with mutlitoken swap any to any by one owner has several pairs and rebalancing, 


# Liquidations

A liquidation is a process that occurs when a borrower's postion is unhealthy.

That happens if collateralization ratio drops below a certain threshold or if [Credit Account] health is below treshhold. 

Once detected, the lending protocol will initiate a sequence of operations to liquidate the collateral of the user in order to obtain more borrow assets and stabilize the collateralization ratio.

Amount is used to repau debt, reward liquidator and remaining, if any, goes back to user.

In case of there is not enough to cover debts, Treasury is used to add more borrow asset back into pool.

#### When collateral ratio may drop?


Borrow price raised or collateral price dropped a lot. Borrower can add more collateral and return some borrow to make ration good again.


### Current Protocols

Lending protocols will often auction off collateral assets, often through an Order Book, or a Dutch Auction. Any account is able to bid/purchase the collateral from the lending protocol, often for an attractive, below market price. Liquidators are then able to to execute an arbitrage to earn a yield, by selling the collateral on a different exchange (often centralized).


Using off-chain liquidators has a number of strategic disadvantages. Liquidators are often anonymous and not invested in the protocol, which means that they are making (a big profit) while disregarding the community. They often collaborate with miners, as liquidations of collateral are a prime target for MEV.


Running liquidations through a decentralized exchange is possible, but the risk of frontrunning makes it economically infeasible on Ethereum. However within the Polkadot and Kusama ecosystem, using technology pioneered by HydraDX, we are actually able to automate and decentralize a liquidation.


### Hybrid Liquidations

By integrating with ~~HydraDX~~, liquidations become trustless, decentralized and transparent to the community. They are also more beneficial to the protocol, as we are able to get market price for the collateral. However as ~~HydraDX~~ is present on a different chain (~~Basilisk~~), we must account for different failure modes, and have fallback strategies. For that we propose a modified Dutch Auction model, which still incorporates a staking model to reward Angular token holders and ties liquidators into our ecosystem


#### Preferred Liquidators

Using a modified Dutch Auction model, we are able to grant certain accounts an advantage during auctions. Given the fictional auction over blocks 1 -> 2 -> 3 -> 4 -> 5, where the price decreases from 100 to 50 linearly for the collateral (100 -> 87.5 -> 75 -> 62.5 -> 50), we reach block 3 of the auction, allowing regular liquidators to purchase the collateral for 75. The preferred liquidator may choose to win that blocks auction, regardless of other offers, by paying the price of the previous block (87.5). Since the liquidator has a 6 second grace period, between block 2 and 3, they are able to execute a matching order on a DEX (say for 89), to pre-sell the collateral for a profit, reducing their risk.

Preferred liquidators may be configured on a per lending pool basis, and are subject to decentralized governance, allowing the community to evict malicious or inactive preferred liquidators.


*<iframe width="100%" src="https://viewer.diagrams.net/?tags=%7B%7D&highlight=0000ff&edit=_blank&layers=1&nav=1&title=dutch-auction-pl.drawio#R7Vlbb9owFP41eezk3Lg8tsDaaZ2G1Enr%2BmaS08RSEiPHgdBfP4c4JLahNwFh0hAP9ufjS75zzucTsNxJWt4yvIx%2F0BASy0FhablTy3Fsz3Gs6ovCjUTGtkQiRkKJtcADeQEJIokWJIRcMeSUJpwsVTCgWQYBVzDMGF2rZs80UXdd4ggM4CHAiYn%2BJiGPa3Tkoxa%2FAxLFzc42kiMpbowlkMc4pOsO5M4sd8Io5XUrLSeQVOw1vNTzvh4Y3R2MQcbfMwHT1eqq8O%2Fjpzz%2FvvjGnvJn90qussJJIR9YHpZvGgYgC68rIkUvSHCek8Byb2KeJgKwRZPRIguh2gSJHoSCPjmZMh7TiGY4mbXojXlueYhqageQT3ELNAXONsKAQYI5WamewdLB0c5uN3VOidjCQTIaPekIGYojpC6Q04IFIOd0eXx9Gc%2FT1uGYRcCNdUSj8zAttPXSBzzmGB77RVIwvSbIvMcLkY7CQ5CTF7zYDiHVeTghUVZ5VjgDmABWwDgR4X8tB1IShgfc9lpAyXSUm7ZJUC0P5XG8rDD7URp9g0bb4FCN7HVMODwscVCNroXcqUweDOt3PHKpRqQWoOtWdwYSijuSM0AnomhgUGSKQ88U2YOeORoaHLmXxtFOsPriaGRw5F0aR67TM0djgyP%2F0jjyUM8cNSVhh6TrgFNmECUqrWXVLNKkNmivte2VOKc54YRW19uCck7TPfcepxqhtOAJyWCyqzPRcVh2bS1dbZNm96w0uwbNBsPHrgmhJPyxsRbtP1X7i6t95OC07FhON53OHJiohbaFTI1lgpBHeaZtp17Yb7rtUtve5i231jXiO2K0LgLfvlxPXfP6anCNP1nzast4%2FnlrXtszQvLnIgcmaHHQnJHggupfmT0XXwDbZgU8nT32ful4eoW352YenlUOzTL4bHJon0gO0cXJYRONp9bDXaGnF8cfVURbk0QHnVkSzTePWQlBwStJvDPfZXvTw8G%2Foofma8r%2FsufoeT48U5rr2fnZNPfG2nWk3zMH0lyECd50zJaVQX74wI62T1PyHzqXYT9U7EWjPsFxNcd8S%2B1ozp506UtzRr1rjui2v%2BzX%2FLd%2FkLizvw%3D%3D"></iframe>*
*Angular: Liquidations Diagram - [Source](https://viewer.diagrams.net/?tags=%7B%7D&highlight=0000ff&edit=_blank&layers=1&nav=1&title=dutch-auction-pl.drawio#R7Vlbb9owFP41eezk3Lg8tsDaaZ2G1Enr%2BmaS08RSEiPHgdBfP4c4JLahNwFh0hAP9ufjS75zzucTsNxJWt4yvIx%2F0BASy0FhablTy3Fsz3Gs6ovCjUTGtkQiRkKJtcADeQEJIokWJIRcMeSUJpwsVTCgWQYBVzDMGF2rZs80UXdd4ggM4CHAiYn%2BJiGPa3Tkoxa%2FAxLFzc42kiMpbowlkMc4pOsO5M4sd8Io5XUrLSeQVOw1vNTzvh4Y3R2MQcbfMwHT1eqq8O%2Fjpzz%2FvvjGnvJn90qussJJIR9YHpZvGgYgC68rIkUvSHCek8Byb2KeJgKwRZPRIguh2gSJHoSCPjmZMh7TiGY4mbXojXlueYhqageQT3ELNAXONsKAQYI5WamewdLB0c5uN3VOidjCQTIaPekIGYojpC6Q04IFIOd0eXx9Gc%2FT1uGYRcCNdUSj8zAttPXSBzzmGB77RVIwvSbIvMcLkY7CQ5CTF7zYDiHVeTghUVZ5VjgDmABWwDgR4X8tB1IShgfc9lpAyXSUm7ZJUC0P5XG8rDD7URp9g0bb4FCN7HVMODwscVCNroXcqUweDOt3PHKpRqQWoOtWdwYSijuSM0AnomhgUGSKQ88U2YOeORoaHLmXxtFOsPriaGRw5F0aR67TM0djgyP%2F0jjyUM8cNSVhh6TrgFNmECUqrWXVLNKkNmivte2VOKc54YRW19uCck7TPfcepxqhtOAJyWCyqzPRcVh2bS1dbZNm96w0uwbNBsPHrgmhJPyxsRbtP1X7i6t95OC07FhON53OHJiohbaFTI1lgpBHeaZtp17Yb7rtUtve5i231jXiO2K0LgLfvlxPXfP6anCNP1nzast4%2FnlrXtszQvLnIgcmaHHQnJHggupfmT0XXwDbZgU8nT32ful4eoW352YenlUOzTL4bHJon0gO0cXJYRONp9bDXaGnF8cfVURbk0QHnVkSzTePWQlBwStJvDPfZXvTw8G%2Foofma8r%2FsufoeT48U5rr2fnZNPfG2nWk3zMH0lyECd50zJaVQX74wI62T1PyHzqXYT9U7EWjPsFxNcd8S%2B1ozp506UtzRr1rjui2v%2BzX%2FLd%2FkLizvw%3D%3D)*


Here, the actor (possibly an off chain worker), first executes the sell side of the collateral. After a successful sale, it uses the preferred liquidator privilege to execute the second half of the arbitrage. If H1 were to fail, the Dutch auction simply continuous using the regular liquidators, ensuring that the collateral is successfully liquidated.


TODO:

* after liquidation happened, where should go amount? should account be erased from debt fully? what percentage to amount can be returned him back? is it possible to partially liquidate? kind of sold out part? different type of auction (acala like)? global vs local liquidation . if sell off did not covered debt, should take amount from stability fee? how to punish operators?

TODO: add discount to liquidators who will depoist their tokens for liqudaion onto picasso protocol under goverannace 


			// TODO: add governance pallet id so that for providers of borrow asset
// TODO: they are issued ANGL denominated normalized asset
// TODO: total ANGL value should be equal to total price of all borrows
// TODO: https://resources.silo.finance/welcome-to-silo/protocol-overview
			// TODO: make liquidation dependtan of healh. so liquidator get more if health is less with some max https://docs.euler.finance/protocol/eulers-default-parameters
			// TODO: allow partial liquidaiton, until health factor returns